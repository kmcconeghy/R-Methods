<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>R-methods</title>
  <meta name="description" content="A collection of working papers covering various statistical, analytical or causal inference problems.">
  <meta name="generator" content="bookdown 0.3.16 and GitBook 2.6.7">

  <meta property="og:title" content="R-methods" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://github.com/kmcconeghy/R-Methods" />
  
  <meta property="og:description" content="A collection of working papers covering various statistical, analytical or causal inference problems." />
  <meta name="github-repo" content="/kmcconeghy/R-Methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R-methods" />
  
  <meta name="twitter:description" content="A collection of working papers covering various statistical, analytical or causal inference problems." />
  

<meta name="author" content="Kevin W. McConeghy">


<meta name="date" content="2017-04-08">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="index.html">
<link rel="next" href="heteroskedastic-cluster-robust-standard-errors.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R-methods</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html"><i class="fa fa-check"></i><b>2</b> Creating Longitudinal Datasets From Individual Records</a><ul>
<li class="chapter" data-level="2.1" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a><ul>
<li class="chapter" data-level="2.1.1" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#packages-to-use"><i class="fa fa-check"></i><b>2.1.1</b> Packages to use</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#construct-dataset"><i class="fa fa-check"></i><b>2.2</b> Construct dataset</a></li>
<li class="chapter" data-level="2.3" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#show-data"><i class="fa fa-check"></i><b>2.3</b> Show Data</a></li>
<li class="chapter" data-level="2.4" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#simple-group-counts"><i class="fa fa-check"></i><b>2.4</b> Simple group counts</a><ul>
<li class="chapter" data-level="2.4.1" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#simple-event-counts"><i class="fa fa-check"></i><b>2.4.1</b> Simple Event Counts</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#cohort-entries-by-year-counts"><i class="fa fa-check"></i><b>2.5</b> Cohort entries by year counts</a></li>
<li class="chapter" data-level="2.6" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#incidence"><i class="fa fa-check"></i><b>2.6</b> Incidence</a></li>
<li class="chapter" data-level="2.7" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#prevalence"><i class="fa fa-check"></i><b>2.7</b> Prevalence</a></li>
<li class="chapter" data-level="2.8" data-path="creating-longitudinal-datasets-from-individual-records.html"><a href="creating-longitudinal-datasets-from-individual-records.html#incidence-density"><i class="fa fa-check"></i><b>2.8</b> Incidence Density</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html"><i class="fa fa-check"></i><b>3</b> Heteroskedastic &amp; Cluster Robust Standard Errors</a><ul>
<li class="chapter" data-level="3.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a><ul>
<li class="chapter" data-level="3.1.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#packages-to-use-1"><i class="fa fa-check"></i><b>3.1.1</b> Packages to use</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#test-data"><i class="fa fa-check"></i><b>3.2</b> Test data</a></li>
<li class="chapter" data-level="3.3" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#linear-regression-model"><i class="fa fa-check"></i><b>3.3</b> Linear Regression Model</a></li>
<li class="chapter" data-level="3.4" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#estimation-of-regression-parameters-and-variance"><i class="fa fa-check"></i><b>3.4</b> Estimation of regression parameters and variance</a><ul>
<li class="chapter" data-level="3.4.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#manually-computed-beta-parameters"><i class="fa fa-check"></i><b>3.4.1</b> Manually computed beta parameters</a></li>
<li class="chapter" data-level="3.4.2" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#manually-computed-standard-errors"><i class="fa fa-check"></i><b>3.4.2</b> Manually computed standard errors</a></li>
<li class="chapter" data-level="3.4.3" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#r-lm-function"><i class="fa fa-check"></i><b>3.4.3</b> R lm function</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#heteroskedascity"><i class="fa fa-check"></i><b>3.5</b> Heteroskedascity</a><ul>
<li class="chapter" data-level="3.5.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#heteroskedascity-in-income-data"><i class="fa fa-check"></i><b>3.5.1</b> Heteroskedascity in income data</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#white-heteroskedastic-consistent-errors"><i class="fa fa-check"></i><b>3.6</b> “White” heteroskedastic consistent errors</a><ul>
<li class="chapter" data-level="3.6.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#manual-estimator"><i class="fa fa-check"></i><b>3.6.1</b> Manual estimator</a></li>
<li class="chapter" data-level="3.6.2" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#r-standard-function"><i class="fa fa-check"></i><b>3.6.2</b> R standard function</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#acknowledgements"><i class="fa fa-check"></i><b>3.7</b> Acknowledgements</a></li>
<li class="chapter" data-level="3.8" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#bibliography"><i class="fa fa-check"></i><b>3.8</b> Bibliography</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html"><i class="fa fa-check"></i><b>4</b> Cluster Robust Standard Errors</a><ul>
<li class="chapter" data-level="4.1" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a><ul>
<li class="chapter" data-level="4.1.1" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#packages-to-use-2"><i class="fa fa-check"></i><b>4.1.1</b> Packages to use</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#clustering"><i class="fa fa-check"></i><b>4.2</b> Clustering</a></li>
<li class="chapter" data-level="4.3" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#cluster-robust-errors-in-r"><i class="fa fa-check"></i><b>4.3</b> Cluster robust errors in R</a></li>
<li class="chapter" data-level="4.4" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#block-bootstrapping"><i class="fa fa-check"></i><b>4.4</b> Block bootstrapping</a></li>
<li class="chapter" data-level="4.5" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#permutation-or-randomization-test"><i class="fa fa-check"></i><b>4.5</b> Permutation or “Randomization” Test</a><ul>
<li class="chapter" data-level="4.5.1" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#bootstrap-program"><i class="fa fa-check"></i><b>4.5.1</b> Bootstrap Program</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#stata-comparison"><i class="fa fa-check"></i><b>4.6</b> Stata comparison</a></li>
<li class="chapter" data-level="4.7" data-path="cluster-robust-standard-errors.html"><a href="cluster-robust-standard-errors.html#acknowledgements-1"><i class="fa fa-check"></i><b>4.7</b> Acknowledgements</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R-methods</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="creating-longitudinal-datasets-from-individual-records" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Creating Longitudinal Datasets From Individual Records</h1>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">2.1</span> Introduction</h2>
<div id="packages-to-use" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Packages to use</h3>
<pre>
 R version 3.3.2 (2016-10-31)
 Platform: x86_64-w64-mingw32/x64 (64-bit)
 Running under: Windows 10 x64 (build 14393)
 
 attached base packages:
 [1] methods   stats     graphics  grDevices utils     datasets  base     
 
 other attached packages:
  [1] gridExtra_2.2.1   lubridate_1.6.0   knitr_1.15.17    
  [4] Scotty_0.0.0.9000 devtools_1.12.0   Hmisc_4.0-2      
  [7] Formula_1.2-1     survival_2.41-2   lattice_0.20-35  
 [10] dplyr_0.5.0       purrr_0.2.2       readr_1.1.0      
 [13] tidyr_0.6.1       tibble_1.2        ggplot2_2.2.1    
 [16] tidyverse_1.1.1  
 </pre>

<p>I often come across the following issue in my work:</p>
<p>Sometimes you are working with a dataset where each row is a nursing home assessment, admission record or some other per person observation. However, perhaps you are more interesting in analyzing group-level changes over time. In order to do this, you need to reshape and summarize these individual records into counts in a “panel” dataset. In this new dataset structure I want each row to be a unique time- group- summary of the data. Some extensions of this include computing incidence (no. events per 1000 persons) and incidence density (no. events per 1000 person-years) measures. I will go through some examples and show how these datasets and measures can be constructed from person or observation unit-level data, assuming you had cohort entry-dates (i.e. admission), event dates (the date of some thing you wish to quantify) and stop-dates (i.e. discharge).</p>
</div>
</div>
<div id="construct-dataset" class="section level2">
<h2><span class="header-section-number">2.2</span> Construct dataset</h2>
<p>First I will construct a test dataset to use in this chapter and subsequent ones.</p>
<p>In this hypothetical I take a group of admissions that starts counting on 2000/01/01. Each entry will have a random exit up to 1000 days from entry, but censored at 2009/12/31 (because in my hypothetical example this is my study endpoint). Each entry will then have a random group classification (state), and event (0 or 1).</p>
<p>The event will be assumed one per admission (E.g. death..). I didn’t allow for multiple admissions by person. I then generate the event as drawn from a random bernoulli distribution with probability <span class="math inline">\(p_g\)</span> Where <span class="math inline">\(g\)</span> is a group-specific effect randomly generated from a uniform distribution between 0 and 0.3.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">12345</span>) <span class="co">#So you get same result</span>
sampsize =<span class="st"> </span><span class="dv">20000</span>
df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id=</span><span class="dv">1</span>:sampsize,
                 <span class="dt">CohortEntry =</span> <span class="kw">sample</span>(<span class="kw">seq</span>(<span class="kw">as.Date</span>(<span class="st">&#39;2000/01/01&#39;</span>), <span class="kw">as.Date</span>(<span class="st">&#39;2009/12/31&#39;</span>), <span class="dt">by=</span><span class="st">&#39;day&#39;</span>), <span class="dt">replace=</span>T, sampsize))
<span class="co">#CohortIn, CohortOut, Group</span>
df &lt;-<span class="st"> </span>df %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">CohortExit =</span> CohortEntry+<span class="kw">sample</span>(<span class="dv">0</span>:<span class="dv">365</span>,sampsize, <span class="dt">replace=</span>T)) %&gt;%<span class="st"> </span><span class="co">#CohortExit Date (up to 1000 days from start)</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">State =</span> <span class="kw">sample</span>(state.name, sampsize, <span class="dt">replace=</span>T)) <span class="co">#Random state for each group</span>
df$CohortExit &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">sapply</span>(df$CohortExit, function(x) <span class="kw">min</span>(x,<span class="kw">as.Date</span>(<span class="st">&#39;2009/12/31&#39;</span>))), <span class="dt">origin=</span>origin) <span class="co">#Censor at &#39;study end&#39;</span>

<span class="co">#Group Effect</span>
  State &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(state.name)
  State$Effect &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">50</span>, <span class="dt">min=</span><span class="dv">0</span>, <span class="dt">max=</span><span class="fl">0.3</span>) <span class="co">#Random effect by group</span>

<span class="co">#Generate random event by group effect</span>
  getReffect &lt;-<span class="st"> </span>function(df, group) {
    p &lt;-<span class="st"> </span>df[df$<span class="st">&#39;state.name&#39;</span>==group,<span class="st">&quot;Effect&quot;</span>]
    event =<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">rbernoulli</span>(<span class="dv">1</span>, <span class="dt">p =</span> p))
    <span class="kw">return</span>(event)
  }
  
df$Event &lt;-<span class="st"> </span><span class="kw">sapply</span>(df$id, function(x) <span class="kw">getReffect</span>(State, df$State[x])) <span class="co">#Generate random event</span>


<span class="co">#For more complicated procedures below, assign random event date between cohort start with event=0 to NA</span>
  randomDate &lt;-<span class="st"> </span>function(TimeIn, TimeOut, Event) {
    RDate &lt;-<span class="st"> </span><span class="kw">sample</span>(TimeIn:TimeOut, <span class="dv">1</span>, <span class="dt">replace=</span>T)
    RDate &lt;-<span class="st"> </span><span class="kw">ifelse</span>(Event==<span class="dv">0</span>,<span class="ot">NA</span>,RDate)
    <span class="kw">return</span>(RDate)
  }
  
  df$EventDate =<span class="st"> </span><span class="kw">sapply</span>(df$id, function(x) <span class="kw">randomDate</span>(df$CohortEntry[x], df$CohortExit[x], df$Event[x]))
  df$EventDate =<span class="st"> </span><span class="kw">as.Date</span>(df$EventDate, <span class="dt">origin=</span>origin)
<span class="kw">kable</span>(<span class="kw">head</span>(df, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">id</th>
<th align="center">CohortEntry</th>
<th align="center">CohortExit</th>
<th align="center">State</th>
<th align="center">Event</th>
<th align="center">EventDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">2007-03-18</td>
<td align="center">2007-10-10</td>
<td align="center">Ohio</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">2008-10-04</td>
<td align="center">2009-10-04</td>
<td align="center">Rhode Island</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">2007-08-11</td>
<td align="center">2008-04-24</td>
<td align="center">Ohio</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">4</td>
<td align="center">2008-11-11</td>
<td align="center">2009-10-26</td>
<td align="center">Nevada</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">5</td>
<td align="center">2004-07-25</td>
<td align="center">2004-08-29</td>
<td align="center">New York</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">6</td>
<td align="center">2001-08-30</td>
<td align="center">2002-05-29</td>
<td align="center">Alaska</td>
<td align="center">1</td>
<td align="center">2002-03-23</td>
</tr>
<tr class="odd">
<td align="center">7</td>
<td align="center">2003-04-02</td>
<td align="center">2004-02-23</td>
<td align="center">North Carolina</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">8</td>
<td align="center">2005-02-03</td>
<td align="center">2005-10-02</td>
<td align="center">Maine</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="odd">
<td align="center">9</td>
<td align="center">2007-04-12</td>
<td align="center">2007-06-09</td>
<td align="center">Nebraska</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
<tr class="even">
<td align="center">10</td>
<td align="center">2009-11-24</td>
<td align="center">2009-12-31</td>
<td align="center">Maine</td>
<td align="center">0</td>
<td align="center">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="show-data" class="section level2">
<h2><span class="header-section-number">2.3</span> Show Data</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Scatter and Fitted Line </span>
p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>df, <span class="kw">aes</span>(<span class="dt">x=</span>CohortEntry)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">y =</span> ..density..), <span class="dt">binwidth =</span> <span class="dv">4</span>, <span class="dt">fill=</span><span class="kw">I</span>(<span class="st">&quot;blue&quot;</span>), <span class="dt">alpha=</span><span class="kw">I</span>(<span class="fl">0.4</span>)) +
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">col=</span><span class="dv">2</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Cohort Entry&quot;</span>) +
<span class="st">  </span><span class="kw">theme_bw</span>()

p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>df, <span class="kw">aes</span>(<span class="dt">x=</span>CohortExit)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">y =</span> ..density..), <span class="dt">binwidth =</span> <span class="dv">4</span>, <span class="dt">fill=</span><span class="kw">I</span>(<span class="st">&quot;blue&quot;</span>), <span class="dt">alpha=</span><span class="kw">I</span>(<span class="fl">0.4</span>)) +
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">col=</span><span class="dv">2</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Cohort Exit&quot;</span>) +
<span class="st">  </span><span class="kw">theme_bw</span>()
<span class="kw">grid.arrange</span>(p1, p2, <span class="dt">nrow=</span><span class="dv">1</span>)</code></pre></div>
<p><img src="01-MungeDays_files/figure-html/EntryDate-1.png" width="768" /></p>
<p>A simple, even distribution to work with (cohort exit is even except for censored at study end date).</p>
</div>
<div id="simple-group-counts" class="section level2">
<h2><span class="header-section-number">2.4</span> Simple group counts</h2>
<p>If you simply seek to count the total no. of records by groups this is simple.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  dfState &lt;-<span class="st"> </span>df %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(State) %&gt;%<span class="st"> </span><span class="co">#Tells dplyr to create grouped object, and then execute following at that unit</span>
<span class="st">      </span><span class="kw">summarise</span>(<span class="dt">Records =</span> <span class="kw">n</span>()) <span class="co">#count individuals</span>
  
  <span class="kw">cat</span>(<span class="st">&quot;Counts of Records by State&quot;</span>)</code></pre></div>
<pre><code>## Counts of Records by State</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">kable</span>(<span class="kw">head</span>(dfState, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">State</th>
<th align="center">Records</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Alabama</td>
<td align="center">396</td>
</tr>
<tr class="even">
<td align="center">Alaska</td>
<td align="center">393</td>
</tr>
<tr class="odd">
<td align="center">Arizona</td>
<td align="center">393</td>
</tr>
<tr class="even">
<td align="center">Arkansas</td>
<td align="center">385</td>
</tr>
<tr class="odd">
<td align="center">California</td>
<td align="center">372</td>
</tr>
<tr class="even">
<td align="center">Colorado</td>
<td align="center">375</td>
</tr>
<tr class="odd">
<td align="center">Connecticut</td>
<td align="center">401</td>
</tr>
<tr class="even">
<td align="center">Delaware</td>
<td align="center">399</td>
</tr>
<tr class="odd">
<td align="center">Florida</td>
<td align="center">376</td>
</tr>
<tr class="even">
<td align="center">Georgia</td>
<td align="center">401</td>
</tr>
</tbody>
</table>
<p>Also, if you wish to see the quantity of some event, this is easy also:</p>
<div id="simple-event-counts" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Simple Event Counts</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  dfState &lt;-<span class="st"> </span>df %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(State) %&gt;%<span class="st"> </span><span class="co">#Tells dplyr to create grouped object, and then execute following at that unit</span>
<span class="st">      </span><span class="kw">summarise</span>(<span class="dt">Events =</span> <span class="kw">sum</span>(Event)) <span class="co">#count no of events</span>
  
  <span class="kw">cat</span>(<span class="st">&quot;Counts of Events by State&quot;</span>)</code></pre></div>
<pre><code>## Counts of Events by State</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">kable</span>(<span class="kw">head</span>(dfState, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">State</th>
<th align="center">Events</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Alabama</td>
<td align="center">46</td>
</tr>
<tr class="even">
<td align="center">Alaska</td>
<td align="center">26</td>
</tr>
<tr class="odd">
<td align="center">Arizona</td>
<td align="center">19</td>
</tr>
<tr class="even">
<td align="center">Arkansas</td>
<td align="center">3</td>
</tr>
<tr class="odd">
<td align="center">California</td>
<td align="center">5</td>
</tr>
<tr class="even">
<td align="center">Colorado</td>
<td align="center">84</td>
</tr>
<tr class="odd">
<td align="center">Connecticut</td>
<td align="center">61</td>
</tr>
<tr class="even">
<td align="center">Delaware</td>
<td align="center">120</td>
</tr>
<tr class="odd">
<td align="center">Florida</td>
<td align="center">113</td>
</tr>
<tr class="even">
<td align="center">Georgia</td>
<td align="center">59</td>
</tr>
</tbody>
</table>
<p>Note how the number of events is quite different by group, because we specified this above. If you wish to count records by time, this is still pretty easy, but you have to be more specific. For example, if I want to count the number of cohort entries by year, this is how:</p>
</div>
</div>
<div id="cohort-entries-by-year-counts" class="section level2">
<h2><span class="header-section-number">2.5</span> Cohort entries by year counts</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#First make year var</span>
df &lt;-<span class="st"> </span>df %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">EntryYear =</span> <span class="kw">year</span>(CohortEntry)) <span class="co">#year function from lubridate</span>
  
<span class="co">#Second group by this var</span>
dfGroup &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(EntryYear) %&gt;%<span class="st">  </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Records =</span> <span class="kw">n</span>(), <span class="dt">Events =</span> <span class="kw">sum</span>(Event)) <span class="co">#count individuals</span>
  <span class="kw">cat</span>(<span class="st">&quot;Counts of Records by Cohort Entry Year&quot;</span>)</code></pre></div>
<pre><code>## Counts of Records by Cohort Entry Year</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">kable</span>(<span class="kw">head</span>(dfGroup, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">EntryYear</th>
<th align="center">Records</th>
<th align="center">Events</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">2000</td>
<td align="center">2015</td>
<td align="center">274</td>
</tr>
<tr class="even">
<td align="center">2001</td>
<td align="center">1987</td>
<td align="center">273</td>
</tr>
<tr class="odd">
<td align="center">2002</td>
<td align="center">2041</td>
<td align="center">288</td>
</tr>
<tr class="even">
<td align="center">2003</td>
<td align="center">1933</td>
<td align="center">295</td>
</tr>
<tr class="odd">
<td align="center">2004</td>
<td align="center">2043</td>
<td align="center">269</td>
</tr>
<tr class="even">
<td align="center">2005</td>
<td align="center">2068</td>
<td align="center">313</td>
</tr>
<tr class="odd">
<td align="center">2006</td>
<td align="center">1964</td>
<td align="center">285</td>
</tr>
<tr class="even">
<td align="center">2007</td>
<td align="center">2019</td>
<td align="center">308</td>
</tr>
<tr class="odd">
<td align="center">2008</td>
<td align="center">1974</td>
<td align="center">297</td>
</tr>
<tr class="even">
<td align="center">2009</td>
<td align="center">1956</td>
<td align="center">293</td>
</tr>
</tbody>
</table>
<p>Here you can see the number who enter the cohort by year, and among those how many events are observed.</p>
</div>
<div id="incidence" class="section level2">
<h2><span class="header-section-number">2.6</span> Incidence</h2>
<p>The next step will get a little trickier. Let’s say we aren’t interested in how many individuals entered/exited the cohort in a given year as above. Rather we want to identify how many patients are in the cohort during a specified period of time (e.g. year). This is the “population at risk”. We wish to estimate the the number of events / population at risk. This is <a href="https://en.wikipedia.org/wiki/Incidence_(epidemiology)">incidence</a>. So we need to take the “CohortEntry”, “CohortExit” date variables and compute how many individuals were in the cohort in year 1, year 2 etc. What makes this tricky is that individuals don’t start and stop at the same time and cross multiple time units (years in this case).</p>
<p>Here is one method where I compute the no. of persons in the cohort in a given year, “incident” events and event rate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="co">#Create New Dataframe by Time Unit</span>
  TimeMin &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">year</span>(df$CohortEntry)) <span class="co">#lowest time unit observed</span>
  TimeMax &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">year</span>(df$CohortExit)) <span class="co">#highest time unit observed</span>
  
  <span class="co">#This following sequence step is good, in case a certain year was skipped </span>
  <span class="co">#(i.e. no admits that year)</span>
  dfTime &lt;-<span class="st"> </span>TimeMin:TimeMax %&gt;%<span class="st"> </span><span class="co">#Sequence years</span>
<span class="st">    </span><span class="kw">as_tibble</span>() %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">x2 =</span> <span class="ot">NA</span>, <span class="dt">x3 =</span> <span class="ot">NA</span>)
    <span class="kw">names</span>(dfTime) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Residents&quot;</span>, <span class="st">&quot;Inc. Events&quot;</span>)
    
  
  <span class="co">#Write a time-interval program for Residence (assuming x is year)</span>
  InCohort &lt;-<span class="st">  </span>function(x, TimeIn, TimeOut) {
    <span class="co">#Note that the following line works because of R vectorization</span>
    count &lt;-<span class="st"> </span><span class="kw">if_else</span>(x&gt;=<span class="kw">year</span>(TimeIn) &amp;<span class="st"> </span>x&lt;=<span class="kw">year</span>(TimeOut),<span class="dv">1</span>,<span class="dv">0</span>) <span class="co">#Test if x is TimeIn&lt;=x&lt;=TimeOut</span>
    InCohortN &lt;-<span class="st"> </span><span class="kw">sum</span>(count) <span class="co">#Add up total people</span>
    <span class="kw">return</span>(InCohortN) <span class="co">#return</span>
  }
  
  <span class="co">#Write a time-interval program for Event</span>
  IncEvent &lt;-<span class="st">  </span>function(x, Event, EventDate) {
    <span class="co">#Note that the following line works because of R vectorization</span>
    events &lt;-<span class="st"> </span><span class="kw">if_else</span>(Event==<span class="dv">1</span> &amp;<span class="st"> </span>x==<span class="kw">year</span>(EventDate),<span class="dv">1</span>,<span class="dv">0</span>) <span class="co">#Added condition of event==1</span>
    InCohortEvents &lt;-<span class="st"> </span><span class="kw">sum</span>(events) <span class="co">#Add up total events in that year</span>
    <span class="kw">return</span>(InCohortEvents) <span class="co">#return</span>
  }
  dfTime$Residents &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) <span class="kw">InCohort</span>(x, df$CohortEntry,df$CohortExit))
  dfTime$<span class="st">&#39;Inc. Events&#39;</span> &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) <span class="kw">IncEvent</span>(x, df$Event, df$EventDate))
  dfTime$<span class="st">&#39;Event Rate&#39;</span> &lt;-<span class="st"> </span>dfTime$<span class="st">&#39;Inc. Events&#39;</span> /<span class="st"> </span>dfTime$Residents
  <span class="kw">kable</span>(<span class="kw">head</span>(dfTime, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>), <span class="dt">digits=</span><span class="dv">3</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">Year</th>
<th align="center">Residents</th>
<th align="center">Inc. Events</th>
<th align="center">Event Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">2000</td>
<td align="center">2015</td>
<td align="center">200</td>
<td align="center">0.099</td>
</tr>
<tr class="even">
<td align="center">2001</td>
<td align="center">2981</td>
<td align="center">271</td>
<td align="center">0.091</td>
</tr>
<tr class="odd">
<td align="center">2002</td>
<td align="center">3040</td>
<td align="center">284</td>
<td align="center">0.093</td>
</tr>
<tr class="even">
<td align="center">2003</td>
<td align="center">2951</td>
<td align="center">291</td>
<td align="center">0.099</td>
</tr>
<tr class="odd">
<td align="center">2004</td>
<td align="center">3034</td>
<td align="center">283</td>
<td align="center">0.093</td>
</tr>
<tr class="even">
<td align="center">2005</td>
<td align="center">3063</td>
<td align="center">299</td>
<td align="center">0.098</td>
</tr>
<tr class="odd">
<td align="center">2006</td>
<td align="center">2956</td>
<td align="center">295</td>
<td align="center">0.100</td>
</tr>
<tr class="even">
<td align="center">2007</td>
<td align="center">2986</td>
<td align="center">301</td>
<td align="center">0.101</td>
</tr>
<tr class="odd">
<td align="center">2008</td>
<td align="center">2972</td>
<td align="center">294</td>
<td align="center">0.099</td>
</tr>
<tr class="even">
<td align="center">2009</td>
<td align="center">2945</td>
<td align="center">373</td>
<td align="center">0.127</td>
</tr>
</tbody>
</table>
<p>I didn’t specify a time-trend in my sample generation, and that is why the event rate is relatively constant over time.</p>
<p>We can double-check this worked with the following specific code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="co">#Logic</span>
  <span class="co"># IF 2004 is less than or equal to EntryDate (i.e. they entered before or during 2004)</span>
  <span class="co"># AND 2004 is less than or equal to Exit (i.e. they exited after or during 2004)</span>
  Check &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="dv">2004</span>&gt;=<span class="kw">year</span>(df$CohortEntry) &amp;<span class="st"> </span><span class="dv">2004</span>&lt;=<span class="kw">year</span>(df$CohortExit),<span class="dv">1</span>,<span class="dv">0</span>)
  <span class="kw">cat</span>(<span class="st">&quot;2004 people :&quot;</span>, <span class="kw">sum</span>(Check))</code></pre></div>
<pre><code>## 2004 people : 3034</code></pre>
</div>
<div id="prevalence" class="section level2">
<h2><span class="header-section-number">2.7</span> Prevalence</h2>
<p>The primary difference between incidence and prevalence is that incidence is only counting <em>new cases</em>. In order to compute prevalence, we need to identify individuals still in the cohort in a given year, but having the event in previous years as well.</p>
<p>Here’s how:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="co">#Code same as above</span>
  TimeMin &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">year</span>(df$CohortEntry)) 
  TimeMax &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">year</span>(df$CohortExit)) 
  dfTime &lt;-<span class="st"> </span>TimeMin:TimeMax %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">as_tibble</span>() %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">x2 =</span> <span class="ot">NA</span>, <span class="dt">x3 =</span> <span class="ot">NA</span>)
    <span class="kw">names</span>(dfTime) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Residents&quot;</span>, <span class="st">&quot;Prev. Events&quot;</span>)
    
  InCohort &lt;-<span class="st">  </span>function(x, TimeIn, TimeOut) {
    count &lt;-<span class="st"> </span><span class="kw">if_else</span>(x&gt;=<span class="kw">year</span>(TimeIn) &amp;<span class="st"> </span>x&lt;=<span class="kw">year</span>(TimeOut),<span class="dv">1</span>,<span class="dv">0</span>) 
    InCohortN &lt;-<span class="st"> </span><span class="kw">sum</span>(count) 
    <span class="kw">return</span>(InCohortN) 
  }
  
  <span class="co">#Write a time-interval program for Event</span>
  PrevEvent &lt;-<span class="st">  </span>function(x, TimeIn, TimeOut, Event, EventDate) {
    <span class="co">#Key difference follows: </span>
    events &lt;-<span class="st"> </span><span class="kw">if_else</span>(x&gt;=<span class="kw">year</span>(TimeIn) &amp;<span class="st"> </span>x&lt;=<span class="kw">year</span>(TimeOut) &amp;<span class="st"> </span>Event==<span class="dv">1</span> &amp;<span class="st"> </span>x&gt;=<span class="kw">year</span>(EventDate),<span class="dv">1</span>,<span class="dv">0</span>)
    InCohortEvents &lt;-<span class="st"> </span><span class="kw">sum</span>(events) <span class="co">#Add up total events in that year</span>
    <span class="kw">return</span>(InCohortEvents) <span class="co">#return</span>
  }
  
  dfTime$Residents &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) <span class="kw">InCohort</span>(x, df$CohortEntry,df$CohortExit))
  dfTime$<span class="st">&#39;Prev. Events&#39;</span> &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) <span class="kw">PrevEvent</span>(x, df$CohortEntry, df$CohortExit, df$Event, df$EventDate))
  dfTime$<span class="st">&#39;Prevalence Rate&#39;</span> &lt;-<span class="st"> </span>dfTime$<span class="st">&#39;Prev. Events&#39;</span> /<span class="st"> </span>dfTime$Residents
  <span class="kw">kable</span>(<span class="kw">head</span>(dfTime, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>), <span class="dt">digits=</span><span class="dv">3</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">Year</th>
<th align="center">Residents</th>
<th align="center">Prev. Events</th>
<th align="center">Prevalence Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">2000</td>
<td align="center">2015</td>
<td align="center">200</td>
<td align="center">0.099</td>
</tr>
<tr class="even">
<td align="center">2001</td>
<td align="center">2981</td>
<td align="center">339</td>
<td align="center">0.114</td>
</tr>
<tr class="odd">
<td align="center">2002</td>
<td align="center">3040</td>
<td align="center">352</td>
<td align="center">0.116</td>
</tr>
<tr class="even">
<td align="center">2003</td>
<td align="center">2951</td>
<td align="center">360</td>
<td align="center">0.122</td>
</tr>
<tr class="odd">
<td align="center">2004</td>
<td align="center">3034</td>
<td align="center">360</td>
<td align="center">0.119</td>
</tr>
<tr class="even">
<td align="center">2005</td>
<td align="center">3063</td>
<td align="center">358</td>
<td align="center">0.117</td>
</tr>
<tr class="odd">
<td align="center">2006</td>
<td align="center">2956</td>
<td align="center">381</td>
<td align="center">0.129</td>
</tr>
<tr class="even">
<td align="center">2007</td>
<td align="center">2986</td>
<td align="center">356</td>
<td align="center">0.119</td>
</tr>
<tr class="odd">
<td align="center">2008</td>
<td align="center">2972</td>
<td align="center">372</td>
<td align="center">0.125</td>
</tr>
<tr class="even">
<td align="center">2009</td>
<td align="center">2945</td>
<td align="center">436</td>
<td align="center">0.148</td>
</tr>
</tbody>
</table>
<p>Note how the prevalence rate is higher, because you are counting events which happened in previous years. Also, the prevalence rate in the first year 2000 is the same as the incidence rate because we have no information before 2000 to add into the prevalent rate. If this is a problem in your empirical research, one approach would be to only count events from 2001 onward, and use the first year as a “lead-in” period.</p>
</div>
<div id="incidence-density" class="section level2">
<h2><span class="header-section-number">2.8</span> Incidence Density</h2>
<p>The next goal is to report not the number of events per total population in a given time interval, but rather the number of events per person time. This is sometimes called <a href="https://en.wikipedia.org/wiki/Incidence_(epidemiology)">incidence density</a>, often reported as “x events per 100-person years”. Conceptually you are saying you would on average expect x events in 1 person followed for 100 years, or x events in 100 persons followed for one year. This can be very useful when there is differing time accrued by the unit of observation (person, admission etc.). However, the relevance and interpretability of this measure is very specific to the thing being studied, i.e. it may not be a reasonable assumption that the event rate is constant over 100 years!</p>
<p>The key new measure here is person-time, heres how to compute it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>df %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">PerTime =</span> <span class="kw">as.integer</span>(CohortExit -<span class="st"> </span>CohortEntry)) <span class="co">#timeDiff</span>
<span class="co">#Second group by this var</span>
dfGroup &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(EntryYear) %&gt;%<span class="st">  </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Records =</span> <span class="kw">n</span>(), <span class="st">&#39;Days in Cohort&#39;</span> =<span class="st"> </span><span class="kw">sum</span>(PerTime)) <span class="co">#count individuals</span>
  <span class="kw">kable</span>(<span class="kw">head</span>(dfGroup, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">EntryYear</th>
<th align="center">Records</th>
<th align="center">Days in Cohort</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">2000</td>
<td align="center">2015</td>
<td align="center">366029</td>
</tr>
<tr class="even">
<td align="center">2001</td>
<td align="center">1987</td>
<td align="center">361894</td>
</tr>
<tr class="odd">
<td align="center">2002</td>
<td align="center">2041</td>
<td align="center">366716</td>
</tr>
<tr class="even">
<td align="center">2003</td>
<td align="center">1933</td>
<td align="center">354578</td>
</tr>
<tr class="odd">
<td align="center">2004</td>
<td align="center">2043</td>
<td align="center">366435</td>
</tr>
<tr class="even">
<td align="center">2005</td>
<td align="center">2068</td>
<td align="center">365334</td>
</tr>
<tr class="odd">
<td align="center">2006</td>
<td align="center">1964</td>
<td align="center">355171</td>
</tr>
<tr class="even">
<td align="center">2007</td>
<td align="center">2019</td>
<td align="center">369771</td>
</tr>
<tr class="odd">
<td align="center">2008</td>
<td align="center">1974</td>
<td align="center">364829</td>
</tr>
<tr class="even">
<td align="center">2009</td>
<td align="center">1956</td>
<td align="center">236663</td>
</tr>
</tbody>
</table>
<p>That was easy! person- or unit-time accrued is simply <code>CohortExit - CohortEntry</code>. However, note we are reporting person-time by the year individuals entered the cohort, not an actual interval of time. It gets more complicated if you want to report aggregated person-time by some time interval. Because our individuals cross years, some of their person time accrues to one or more years.</p>
<p>Here is how to do this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Code same as above</span>
  TimeMin &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">year</span>(df$CohortEntry)) 
  TimeMax &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">year</span>(df$CohortExit)) 
  dfTime &lt;-<span class="st"> </span>TimeMin:TimeMax %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">as_tibble</span>() %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">x2 =</span> <span class="ot">NA</span>, <span class="dt">x3 =</span> <span class="ot">NA</span>)
    <span class="kw">names</span>(dfTime) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Year&#39;</span>, <span class="st">&#39;Residents&#39;</span>,<span class="st">&#39;Inc. Events&#39;</span>)
    
  InCohort &lt;-<span class="st">  </span>function(x, TimeIn, TimeOut) {
    count &lt;-<span class="st"> </span><span class="kw">if_else</span>(x&gt;=<span class="kw">year</span>(TimeIn) &amp;<span class="st"> </span>x&lt;=<span class="kw">year</span>(TimeOut),<span class="dv">1</span>,<span class="dv">0</span>) 
    InCohortN &lt;-<span class="st"> </span><span class="kw">sum</span>(count) 
    <span class="kw">return</span>(InCohortN) 
  }

  dfTime$Residents &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) 
    <span class="kw">InCohort</span>(x, df$CohortEntry,df$CohortExit)) <span class="co">#Number of residents</span>
  
  IncEvent &lt;-<span class="st">  </span>function(x, Event, EventDate) {
    <span class="co">#Note that the following line works because of R vectorization</span>
    events &lt;-<span class="st"> </span><span class="kw">if_else</span>(Event==<span class="dv">1</span> &amp;<span class="st"> </span>x==<span class="kw">year</span>(EventDate),<span class="dv">1</span>,<span class="dv">0</span>) <span class="co">#Added condition of event==1</span>
    InCohortEvents &lt;-<span class="st"> </span><span class="kw">sum</span>(events) <span class="co">#Add up total events in that year</span>
    <span class="kw">return</span>(InCohortEvents) <span class="co">#return</span>
  }
  
  dfTime$<span class="st">&#39;Inc. Events&#39;</span> &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) 
    <span class="kw">IncEvent</span>(x, df$Event, df$EventDate))

  <span class="co">#Function to compute person time</span>
  TimeInCohort &lt;-<span class="st"> </span>function(x, TimeIn, TimeOut) {
    
    <span class="co">#Key steps here:</span>
    FirstDay &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">paste0</span>(<span class="st">&#39;01/01/&#39;</span>,x), <span class="dt">format=</span><span class="st">&#39;%m/%d/%Y&#39;</span>, <span class="dt">origin=</span>origin)
    LastDay &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">paste0</span>(<span class="st">&#39;12/31/&#39;</span>,x), <span class="dt">format=</span><span class="st">&#39;%m/%d/%Y&#39;</span>, <span class="dt">origin=</span>origin)
    
    <span class="co">#Compute starting point as either first day of year or TimeIn </span>
    <span class="co">#if TimeIn is &gt; FirstDay</span>
    <span class="co">#&#39;&#39; opposite for Year Stop</span>
    YearStart &lt;-<span class="st"> </span><span class="kw">sapply</span>(TimeIn, function(x) <span class="kw">max</span>(x, FirstDay))
    YearStop &lt;-<span class="st"> </span><span class="kw">sapply</span>(TimeOut, function(x) <span class="kw">min</span>(x, LastDay))
    
    <span class="co">#Compute DaysInYear, if present in that year</span>
    DaysInYear  &lt;-<span class="st"> </span><span class="kw">ifelse</span>(x&gt;=<span class="kw">year</span>(TimeIn) &amp;<span class="st"> </span>x&lt;=<span class="kw">year</span>(TimeOut), YearStop -<span class="st"> </span>YearStart, <span class="dv">0</span>)
    InCohortDays &lt;-<span class="st"> </span><span class="kw">sum</span>(DaysInYear) 
    <span class="kw">return</span>(InCohortDays)
  }  
  dfTime$<span class="st">&#39;Person Time&#39;</span> &lt;-<span class="st"> </span><span class="kw">sapply</span>(dfTime$Year, function(x) 
    <span class="kw">TimeInCohort</span>(x, df$CohortEntry,df$CohortExit)) <span class="co">#Person time per year</span>
  

  <span class="kw">kable</span>(<span class="kw">head</span>(dfTime, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">Year</th>
<th align="center">Residents</th>
<th align="center">Inc. Events</th>
<th align="center">Person Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">2000</td>
<td align="center">2015</td>
<td align="center">200</td>
<td align="center">242146</td>
</tr>
<tr class="even">
<td align="center">2001</td>
<td align="center">2981</td>
<td align="center">271</td>
<td align="center">363133</td>
</tr>
<tr class="odd">
<td align="center">2002</td>
<td align="center">3040</td>
<td align="center">284</td>
<td align="center">364779</td>
</tr>
<tr class="even">
<td align="center">2003</td>
<td align="center">2951</td>
<td align="center">291</td>
<td align="center">357520</td>
</tr>
<tr class="odd">
<td align="center">2004</td>
<td align="center">3034</td>
<td align="center">283</td>
<td align="center">360320</td>
</tr>
<tr class="even">
<td align="center">2005</td>
<td align="center">3063</td>
<td align="center">299</td>
<td align="center">369744</td>
</tr>
<tr class="odd">
<td align="center">2006</td>
<td align="center">2956</td>
<td align="center">295</td>
<td align="center">353797</td>
</tr>
<tr class="even">
<td align="center">2007</td>
<td align="center">2986</td>
<td align="center">301</td>
<td align="center">365960</td>
</tr>
<tr class="odd">
<td align="center">2008</td>
<td align="center">2972</td>
<td align="center">294</td>
<td align="center">362423</td>
</tr>
<tr class="even">
<td align="center">2009</td>
<td align="center">2945</td>
<td align="center">373</td>
<td align="center">358655</td>
</tr>
</tbody>
</table>
<p>Then from this computing the incidence density rate is trivial, and you can report as some arbitrary quantity (i.e. per 100 years).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Code same as above</span>
  <span class="co">#Events / Patient Days</span>
  dfTime$<span class="st">`</span><span class="dt">Incidence Density</span><span class="st">`</span> &lt;-<span class="st"> </span>dfTime$<span class="st">`</span><span class="dt">Inc. Events</span><span class="st">`</span> /<span class="st"> </span>dfTime$<span class="st">`</span><span class="dt">Person Time</span><span class="st">`</span>
  
  <span class="co">#Events / Patients Days * 365 days * 100 years</span>
  dfTime$<span class="st">`</span><span class="dt">Event rate per 100 person years</span><span class="st">`</span> &lt;-<span class="st"> </span>dfTime$<span class="st">`</span><span class="dt">Incidence Density</span><span class="st">`</span> *<span class="st"> </span><span class="dv">365</span> *<span class="st"> </span><span class="dv">100</span>
  
  <span class="kw">kable</span>(<span class="kw">head</span>(dfTime, <span class="dt">n=</span><span class="dv">10</span>), <span class="dt">align=</span><span class="kw">c</span>(<span class="st">&#39;c&#39;</span>), <span class="dt">digits =</span> <span class="dv">4</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="center">Year</th>
<th align="center">Residents</th>
<th align="center">Inc. Events</th>
<th align="center">Person Time</th>
<th align="center">Incidence Density</th>
<th align="center">Event rate per 100 person years</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">2000</td>
<td align="center">2015</td>
<td align="center">200</td>
<td align="center">242146</td>
<td align="center">8e-04</td>
<td align="center">30.1471</td>
</tr>
<tr class="even">
<td align="center">2001</td>
<td align="center">2981</td>
<td align="center">271</td>
<td align="center">363133</td>
<td align="center">7e-04</td>
<td align="center">27.2393</td>
</tr>
<tr class="odd">
<td align="center">2002</td>
<td align="center">3040</td>
<td align="center">284</td>
<td align="center">364779</td>
<td align="center">8e-04</td>
<td align="center">28.4172</td>
</tr>
<tr class="even">
<td align="center">2003</td>
<td align="center">2951</td>
<td align="center">291</td>
<td align="center">357520</td>
<td align="center">8e-04</td>
<td align="center">29.7088</td>
</tr>
<tr class="odd">
<td align="center">2004</td>
<td align="center">3034</td>
<td align="center">283</td>
<td align="center">360320</td>
<td align="center">8e-04</td>
<td align="center">28.6676</td>
</tr>
<tr class="even">
<td align="center">2005</td>
<td align="center">3063</td>
<td align="center">299</td>
<td align="center">369744</td>
<td align="center">8e-04</td>
<td align="center">29.5164</td>
</tr>
<tr class="odd">
<td align="center">2006</td>
<td align="center">2956</td>
<td align="center">295</td>
<td align="center">353797</td>
<td align="center">8e-04</td>
<td align="center">30.4341</td>
</tr>
<tr class="even">
<td align="center">2007</td>
<td align="center">2986</td>
<td align="center">301</td>
<td align="center">365960</td>
<td align="center">8e-04</td>
<td align="center">30.0210</td>
</tr>
<tr class="odd">
<td align="center">2008</td>
<td align="center">2972</td>
<td align="center">294</td>
<td align="center">362423</td>
<td align="center">8e-04</td>
<td align="center">29.6090</td>
</tr>
<tr class="even">
<td align="center">2009</td>
<td align="center">2945</td>
<td align="center">373</td>
<td align="center">358655</td>
<td align="center">1e-03</td>
<td align="center">37.9599</td>
</tr>
</tbody>
</table>
<p>The intepretation “In 2003, the event rate per 100 person-years was 12.1” or “In 2003, the 1-year risk of an event is 12.1 per 100 persons”.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="heteroskedastic-cluster-robust-standard-errors.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
