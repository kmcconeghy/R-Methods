<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>R-methods</title>
  <meta name="description" content="A collection of working papers covering various statistical, analytical or causal inference problems.">
  <meta name="generator" content="bookdown 0.3.16 and GitBook 2.6.7">

  <meta property="og:title" content="R-methods" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://github.com/kmcconeghy/R-Methods" />
  
  <meta property="og:description" content="A collection of working papers covering various statistical, analytical or causal inference problems." />
  <meta name="github-repo" content="/kmcconeghy/R-Methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R-methods" />
  
  <meta name="twitter:description" content="A collection of working papers covering various statistical, analytical or causal inference problems." />
  

<meta name="author" content="Kevin W. McConeghy">


<meta name="date" content="2017-03-30">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="index.html">
<link rel="next" href="diving-in.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R-methods</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#setup-for-rmd-documents"><i class="fa fa-check"></i><b>0.1</b> Setup for Rmd documents</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html"><i class="fa fa-check"></i><b>1</b> Heteroskedastic &amp; Cluster Robust Standard Errors</a><ul>
<li class="chapter" data-level="1.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#rs-calculation-of-standard-errors"><i class="fa fa-check"></i><b>1.1</b> R’s calculation of standard errors</a></li>
<li class="chapter" data-level="1.2" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#heteroskedascity"><i class="fa fa-check"></i><b>1.2</b> Heteroskedascity</a></li>
<li class="chapter" data-level="1.3" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#clustering"><i class="fa fa-check"></i><b>1.3</b> Clustering</a></li>
<li class="chapter" data-level="1.4" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#stata-comparison"><i class="fa fa-check"></i><b>1.4</b> Stata comparison</a></li>
<li class="chapter" data-level="1.5" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#heteroskedastic-consistent-errors-in-r"><i class="fa fa-check"></i><b>1.5</b> Heteroskedastic consistent errors in R</a></li>
<li class="chapter" data-level="1.6" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#cluster-robust-errors-in-r"><i class="fa fa-check"></i><b>1.6</b> Cluster robust errors in R</a></li>
<li class="chapter" data-level="1.7" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#block-bootstrapping"><i class="fa fa-check"></i><b>1.7</b> Block bootstrapping</a><ul>
<li class="chapter" data-level="1.7.1" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#bootstrap-program"><i class="fa fa-check"></i><b>1.7.1</b> Bootstrap Program</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="heteroskedastic-cluster-robust-standard-errors.html"><a href="heteroskedastic-cluster-robust-standard-errors.html#computer-session"><i class="fa fa-check"></i><b>1.8</b> Computer Session</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="diving-in.html"><a href="diving-in.html"><i class="fa fa-check"></i><b>2</b> Diving In</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R-methods</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="heteroskedastic-cluster-robust-standard-errors" class="section level1">
<h1><span class="header-section-number">Chapter 1</span> Heteroskedastic &amp; Cluster Robust Standard Errors</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(<span class="st">&quot;tidyverse&quot;</span>)</code></pre></div>
<pre><code>## Loading required package: tidyverse</code></pre>
<pre><code>## Warning: package &#39;tidyverse&#39; was built under R version 3.3.3</code></pre>
<pre><code>## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr</code></pre>
<pre><code>## Warning: package &#39;readr&#39; was built under R version 3.3.3</code></pre>
<pre><code>## Conflicts with tidy packages ----------------------------------------------</code></pre>
<pre><code>## filter(): dplyr, stats
## lag():    dplyr, stats</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(<span class="st">&quot;sandwich&quot;</span>)</code></pre></div>
<pre><code>## Loading required package: sandwich</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(<span class="st">&quot;lmtest&quot;</span>)</code></pre></div>
<pre><code>## Loading required package: lmtest</code></pre>
<pre><code>## Warning: package &#39;lmtest&#39; was built under R version 3.3.3</code></pre>
<pre><code>## Loading required package: zoo</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(<span class="st">&quot;boot&quot;</span>)</code></pre></div>
<pre><code>## Loading required package: boot</code></pre>
<div id="rs-calculation-of-standard-errors" class="section level2">
<h2><span class="header-section-number">1.1</span> R’s calculation of standard errors</h2>
</div>
<div id="heteroskedascity" class="section level2">
<h2><span class="header-section-number">1.2</span> Heteroskedascity</h2>
</div>
<div id="clustering" class="section level2">
<h2><span class="header-section-number">1.3</span> Clustering</h2>
</div>
<div id="stata-comparison" class="section level2">
<h2><span class="header-section-number">1.4</span> Stata comparison</h2>
<p>In Stata, one can specify a variance-covariance matrix that is heteroskedastic consistent with the <em>vce(robust)</em> option in regression models.</p>
<p>e.g. STATA example</p>
<pre><code>regress y x z, vce(robust)</code></pre>
<p>A Huber-White variance-covariance matrix can also be computed with a cluster option by some group with the <em>vce(cluster(group))</em> option in regression models.</p>
<p>e.g. STATA example</p>
<pre><code>regress y x z, vce(cluster(group))</code></pre>
</div>
<div id="heteroskedastic-consistent-errors-in-r" class="section level2">
<h2><span class="header-section-number">1.5</span> Heteroskedastic consistent errors in R</h2>
</div>
<div id="cluster-robust-errors-in-r" class="section level2">
<h2><span class="header-section-number">1.6</span> Cluster robust errors in R</h2>
</div>
<div id="block-bootstrapping" class="section level2">
<h2><span class="header-section-number">1.7</span> Block bootstrapping</h2>
<p>An alternative to computing special variance-covariance matrices is non-parametric “block” bootstrapping. To do this, you perform a bootstrapping procedure where you sample the group or “block” instead of unit observation. This has been shown to be about as consistent and unbiased as the above sandwich estimators, and may be advantgeous when the number of clusters is small.(Insert Bertrand citation).</p>
<div id="bootstrap-program" class="section level3">
<h3><span class="header-section-number">1.7.1</span> Bootstrap Program</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Boot.ATE &lt;-<span class="st"> </span>function (model, treat, <span class="dt">R =</span> <span class="dv">250</span>, <span class="dt">block =</span> <span class="st">&quot;&quot;</span>, df) 
{
  <span class="kw">require</span>(boot)
  <span class="kw">require</span>(dplyr)
  family &lt;-<span class="st"> </span>model$family
  if (block ==<span class="st"> &quot;&quot;</span>) {
    boot.mod &lt;-<span class="st"> </span>function(x, i, model, treat) {
      samp.df &lt;-<span class="st"> </span>x[i, ]
      samp.glm &lt;-<span class="st"> </span><span class="kw">try</span>(<span class="kw">glm</span>(model, <span class="dt">data =</span> samp.df, <span class="dt">family =</span> family))
      if (<span class="kw">inherits</span>(samp.glm, <span class="st">&quot;try-error&quot;</span>)) {
        coef &lt;-<span class="st"> </span><span class="ot">NA</span>
        ate &lt;-<span class="st"> </span><span class="ot">NA</span>
        rr &lt;-<span class="st"> </span><span class="ot">NA</span>
        <span class="kw">c</span>(coef, ate, rr)
      }
      else {
        df2 &lt;-<span class="st"> </span>samp.df
        df2[, <span class="kw">paste</span>(treat)] =<span class="st"> </span><span class="dv">1</span>
        pred1. &lt;-<span class="st"> </span><span class="kw">predict.glm</span>(samp.glm, <span class="dt">newdata =</span> df2, 
          <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
        df2[, <span class="kw">paste</span>(treat)] =<span class="st"> </span><span class="dv">0</span>
        pred0. &lt;-<span class="st"> </span><span class="kw">predict.glm</span>(samp.glm, <span class="dt">newdata =</span> df2, 
          <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
        coef &lt;-<span class="st"> </span>samp.glm$coefficients[<span class="kw">paste0</span>(treat)]
        ate &lt;-<span class="st"> </span><span class="kw">mean</span>(pred1.) -<span class="st"> </span><span class="kw">mean</span>(pred0.)
        rr &lt;-<span class="st"> </span><span class="kw">mean</span>(pred1.)/<span class="kw">mean</span>(pred0.)
        <span class="kw">c</span>(coef, ate, rr)
      }
    }
    boot.m &lt;-<span class="st"> </span><span class="kw">boot</span>(<span class="dt">data =</span> df, <span class="dt">statistic =</span> boot.mod, <span class="dt">R =</span> R, 
      <span class="dt">model =</span> model, <span class="dt">treat =</span> treat)
  }
  else {
    Groups =<span class="st"> </span><span class="kw">unique</span>(df[, <span class="kw">paste</span>(block)])
    boot.mod &lt;-<span class="st"> </span>function(x, i, model, treat, df, block, 
      <span class="dt">iter =</span> <span class="dv">0</span>) {
      block.df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">group =</span> x[i])
      <span class="kw">names</span>(block.df) =<span class="st"> </span>block
      samp.df &lt;-<span class="st"> </span><span class="kw">left_join</span>(block.df, df, <span class="dt">by =</span> block)
      samp.glm &lt;-<span class="st"> </span><span class="kw">try</span>(<span class="kw">glm</span>(model, <span class="dt">data =</span> samp.df, <span class="dt">family =</span> family))
      if (<span class="kw">inherits</span>(samp.glm, <span class="st">&quot;try-error&quot;</span>)) {
        coef &lt;-<span class="st"> </span><span class="ot">NA</span>
        ate &lt;-<span class="st"> </span><span class="ot">NA</span>
        rr &lt;-<span class="st"> </span><span class="ot">NA</span>
        <span class="kw">c</span>(coef, ate, rr)
      }
      else {
        df2 &lt;-<span class="st"> </span>samp.df
        df2[, <span class="kw">paste</span>(treat)] =<span class="st"> </span><span class="dv">1</span>
        pred1. &lt;-<span class="st"> </span><span class="kw">predict.glm</span>(samp.glm, <span class="dt">newdata =</span> df2, 
          <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
        df2[, <span class="kw">paste</span>(treat)] =<span class="st"> </span><span class="dv">0</span>
        pred0. &lt;-<span class="st"> </span><span class="kw">predict.glm</span>(samp.glm, <span class="dt">newdata =</span> df2, 
          <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)
        coef &lt;-<span class="st"> </span>samp.glm$coefficients[<span class="kw">paste0</span>(treat)]
        ate &lt;-<span class="st"> </span><span class="kw">mean</span>(pred1.) -<span class="st"> </span><span class="kw">mean</span>(pred0.)
        rr &lt;-<span class="st"> </span><span class="kw">mean</span>(pred1.)/<span class="kw">mean</span>(pred0.)
        <span class="kw">c</span>(coef, ate, rr)
      }
    }
    boot.m &lt;-<span class="st"> </span><span class="kw">boot</span>(<span class="dt">data =</span> Groups, <span class="dt">statistic =</span> boot.mod, 
      <span class="dt">R =</span> R, <span class="dt">model =</span> model, <span class="dt">treat =</span> treat, <span class="dt">df =</span> df, <span class="dt">block =</span> block)
  }
  m1.confint &lt;-<span class="st"> </span><span class="kw">c</span>(model$coefficients[<span class="kw">paste0</span>(treat)], <span class="kw">confint</span>(model, 
    treat, <span class="dt">level =</span> <span class="fl">0.95</span>))
  coeff =<span class="st"> </span><span class="kw">boot.ci</span>(boot.m, <span class="dt">index =</span> <span class="dv">1</span>, <span class="dt">type =</span> <span class="st">&quot;perc&quot;</span>)
  coeff =<span class="st"> </span><span class="kw">c</span>(<span class="kw">median</span>(boot.m$t[, <span class="dv">1</span>]), coeff$percent[, <span class="dv">4</span>], coeff$percent[, 
    <span class="dv">5</span>])
  <span class="kw">names</span>(coeff) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Coeff.&quot;</span>, <span class="st">&quot;2.5%&quot;</span>, <span class="st">&quot;97.5%&quot;</span>)
  ate =<span class="st"> </span><span class="kw">boot.ci</span>(boot.m, <span class="dt">index =</span> <span class="dv">2</span>, <span class="dt">type =</span> <span class="st">&quot;perc&quot;</span>)
  ate =<span class="st"> </span><span class="kw">c</span>(<span class="kw">median</span>(boot.m$t[, <span class="dv">2</span>]), ate$percent[, <span class="dv">4</span>], ate$percent[, 
    <span class="dv">5</span>])
  <span class="kw">names</span>(ate) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ATE&quot;</span>, <span class="st">&quot;2.5%&quot;</span>, <span class="st">&quot;97.5%&quot;</span>)
  rr =<span class="st"> </span><span class="kw">boot.ci</span>(boot.m, <span class="dt">index =</span> <span class="dv">3</span>, <span class="dt">type =</span> <span class="st">&quot;perc&quot;</span>)
  rr =<span class="st"> </span><span class="kw">c</span>(<span class="kw">median</span>(boot.m$t[, <span class="dv">3</span>]), rr$percent[, <span class="dv">4</span>], rr$percent[, 
    <span class="dv">5</span>])
  <span class="kw">names</span>(rr) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Rr&quot;</span>, <span class="st">&quot;2.5%&quot;</span>, <span class="st">&quot;97.5%&quot;</span>)
  boot.iter =<span class="st"> </span>boot.m$t
  res =<span class="st"> </span><span class="kw">list</span>(<span class="dt">level =</span> <span class="fl">0.95</span>, <span class="dt">model_ci =</span> m1.confint, <span class="dt">coeff =</span> coeff, 
    <span class="dt">ate =</span> ate, <span class="dt">rr =</span> rr, <span class="dt">boots =</span> boot.iter)
  <span class="kw">return</span>(res)
}</code></pre></div>
</div>
</div>
<div id="computer-session" class="section level2">
<h2><span class="header-section-number">1.8</span> Computer Session</h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="diving-in.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
